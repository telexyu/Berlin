<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calcolo Distanza Berlino con Itinerario e Satellite</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 80%;
      width: 100%;
    }
  </style>
</head>
<body class="flex flex-col">
  <div id="map"></div>

  <!-- Info Box -->
  <div class="p-4 bg-white shadow-md text-sm">
    <div id="info" class="mb-2">Clicca sulla mappa per aggiungere due punti.</div>
    <button id="reset" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Reset</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    let map = L.map('map').setView([52.52, 13.405], 13); // Centro di Berlino
    let points = [];
    let routingControl = null;
    let markerLayer = L.layerGroup().addTo(map);

    // Aggiungiamo la mappa base (OpenStreetMap)
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    // Aggiungiamo la mappa satellite (Esri)
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    // Impostiamo la mappa iniziale a OpenStreetMap
    osmLayer.addTo(map);

    // Controllo per passare tra la mappa normale e satellite
    const baseMaps = {
      "Mappa Normale": osmLayer,
      "Satellite": satelliteLayer
    };
    
    L.control.layers(baseMaps).addTo(map);

    // Aggiunta dei marker sui luoghi di Berlino
    const landmarks = [
      { name: "Brandenburger Tor", coords: [52.5160, 13.3779], description: "Famoso arco trionfale di Berlino." },
      { name: "Reichstag", coords: [52.5186, 13.3762], description: "Sede del Parlamento tedesco." },
      { name: "Museo dell'Isola", coords: [52.5219, 13.4017], description: "Complesso di musei storici." },
      { name: "Checkpoint Charlie", coords: [52.5076, 13.3904], description: "Ex punto di passaggio durante la Guerra Fredda." },
      { name: "East Side Gallery", coords: [52.5050, 13.4396], description: "Tratto del Muro di Berlino trasformato in galleria d'arte." },
    ];

    landmarks.forEach((landmark) => {
      const marker = L.marker(landmark.coords).addTo(markerLayer)
        .bindPopup(`<b>${landmark.name}</b><br>${landmark.description}`)
        .openPopup();
    });

    // Aggiunta dei marker e calcolo del percorso
    map.on('click', function(e) {
      if (points.length >= 2) return;

      const marker = L.marker(e.latlng).addTo(markerLayer);
      points.push(e.latlng);

      if (points.length === 2) {
        drawRoute(points[0], points[1]);
      }
    });

    // Disegna il percorso
    function drawRoute(p1, p2) {
      if (routingControl) map.removeControl(routingControl);

      routingControl = L.Routing.control({
        waypoints: [p1, p2],
        lineOptions: {
          styles: [{ color: 'red', weight: 6 }]
        },
        addWaypoints: false,
        routeWhileDragging: false,
        draggableWaypoints: false,
        createMarker: () => null
      })
      .on('routesfound', function(e) {
        const route = e.routes[0];
        const distanceKm = (route.summary.totalDistance / 1000).toFixed(2);
        const timeAuto = (route.summary.totalDistance / 1000 / 50 * 60).toFixed(1);  // 50 km/h
        const timePiedi = (route.summary.totalDistance / 1000 / 5 * 60).toFixed(1);  // 5 km/h

        document.getElementById('info').innerHTML = `
          üìç Distanza: <strong>${distanceKm} km</strong><br>
          üöó In auto: <strong>${timeAuto} minuti</strong><br>
          üö∂‚Äç‚ôÇÔ∏è A piedi: <strong>${timePiedi} minuti</strong>
        `;
      })
      .addTo(map);
    }

    // Reset
    document.getElementById('reset').addEventListener('click', () => {
      points = [];
      markerLayer.clearLayers();
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      // Aggiungi i marker predefiniti
      landmarks.forEach((landmark) => {
        const marker = L.marker(landmark.coords).addTo(markerLayer)
          .bindPopup(`<b>${landmark.name}</b><br>${landmark.description}`)
          .openPopup();
      });
      document.getElementById('info').innerText = 'Clicca sulla mappa per aggiungere due punti.';
    });
  </script>
</body>
</html>
